<tool id="crbeam_astro_tool" name="CRbeam" version="0.0.1+galaxy0" profile="23.0">
  <requirements>
    <requirement type="package" version="1.1.1">crbeam</requirement>
    <requirement type="package" version="19.0.1">pyarrow</requirement>
    <requirement type="package" version="6.0">unzip</requirement>
    <requirement type="package" version="9.0.2">ipython</requirement>
    <requirement type="package" version="5.3">astropy</requirement>
    <requirement type="package" version="3.10.1">matplotlib</requirement>
    <requirement type="package" version="0.4.9.post1">astroquery</requirement>
    <requirement type="package" version="1.11.4">scipy</requirement>
    <requirement type="package" version="1.2.33">oda-api</requirement>
    <requirement type="package" version="7.16.6">nbconvert</requirement>
    <!--Requirements string 'nb2workflow[cwl,service,rdf,mmoda]>=1.3.30 
' can't be converted automatically. Please add the galaxy/conda requirement manually or modify the requirements file!-->
    <requirement type="package" version="0.13.2">seaborn</requirement>
    <requirement type="package" version="7.2.15">minio</requirement>
    <requirement type="package" version="1.19.0">specutils</requirement>
    <requirement type="package" version="1.3">gammapy</requirement>
  </requirements>
  <command detect_errors="exit_code">ipython '$__tool_directory__/${_data_product._selector}.py'</command>
  <configfiles>
    <inputs name="inputs" filename="inputs.json" data_style="paths" />
  </configfiles>
  <environment_variables>
    <environment_variable name="BASEDIR">$__tool_directory__</environment_variable>
    <environment_variable name="GALAXY_TOOL_DIR">$__tool_directory__</environment_variable>
  </environment_variables>
  <inputs>
    <conditional name="_data_product">
      <param name="_selector" type="select" label="Data Product">
        <option value="Generate_events" selected="true">Generate_events</option>
        <option value="histogram_column" selected="false">histogram_column</option>
        <option value="CRbeam" selected="false">CRbeam</option>
        <option value="model_CTA_events" selected="false">model_CTA_events</option>
        <option value="filter_table" selected="false">filter_table</option>
        <option value="compute_new_column" selected="false">compute_new_column</option>
      </param>
      <when value="Generate_events">
        <param name="src_name" type="text" value="1ES 1215+303" label="src_name" />
        <param name="z_start" type="float" value="0.13" label="z_start" />
        <param name="Npart" type="integer" value="10000" label="Npart" min="1" max="100000" />
        <param name="particle_type" type="select" label="particle_type">
          <option value="electron">electron</option>
          <option value="gamma" selected="true">gamma</option>
          <option value="proton">proton</option>
        </param>
        <param name="Emax" type="float" value="50" label="Emax (unit: TeV)" />
        <param name="Emin" type="float" value="0.01" label="Emin (unit: TeV)" />
        <param name="EminSource" type="float" value="0.01" label="EminSource (unit: TeV)" />
        <param name="Gamma" type="float" value="2.0" label="Gamma" />
        <param name="EGMF_fG" type="float" value="100" label="EGMF_fG" />
        <param name="lmaxEGMF_Mpc" type="float" value="5" label="lmaxEGMF_Mpc" />
        <param name="jet_half_size" type="float" value="180.0" label="jet_half_size (unit: deg)" />
        <param name="jet_direction" type="float" value="0.0" label="jet_direction (unit: deg)" />
        <param name="psf" type="float" value="180.0" label="psf (unit: deg)" />
        <param name="window_size_RA" type="float" value="4.0" label="window_size_RA (unit: deg)" />
        <param name="window_size_DEC" type="float" value="4.0" label="window_size_DEC (unit: deg)" />
        <param name="EBL" type="select" label="EBL">
          <option value="Franceschini 2017" selected="true">Franceschini 2017</option>
          <option value="Inoue 2012 Baseline">Inoue 2012 Baseline</option>
          <option value="Inoue 2012 lower limit">Inoue 2012 lower limit</option>
          <option value="Inoue 2012 upper limit">Inoue 2012 upper limit</option>
          <option value="Stecker 2016 lower limit">Stecker 2016 lower limit</option>
          <option value="Stecker 2016 upper limit">Stecker 2016 upper limit</option>
        </param>
      </when>
      <when value="histogram_column">
        <param name="fn" type="data" label="fn" format="data" />
        <param name="sep" type="text" value="comma" label="sep" />
        <param name="column" type="text" value="c0" label="column" />
        <param name="weights" type="text" value="c1" label="weights" />
        <param name="binning" type="select" label="binning">
          <option value="linear">linear</option>
          <option value="logarithmic" selected="true">logarithmic</option>
        </param>
        <param name="minval" type="float" value="10000000000.0" label="minval" />
        <param name="maxval" type="float" value="10000000000000.0" label="maxval" />
        <param name="nbins" type="integer" value="15" label="nbins" />
        <param name="xlabel" type="text" value="Energy, eV" label="xlabel" />
        <param name="ylabel" type="text" value="Ncounts" label="ylabel" />
      </when>
      <when value="CRbeam">
        <param name="src_name" type="text" value="NGC 1365" label="src_name" />
        <param name="z_start" type="float" value="0" label="z_start" />
        <param name="Npart" type="integer" value="2000" label="Npart" min="1" max="100000" />
        <param name="particle_type" type="select" label="particle_type">
          <option value="electron">electron</option>
          <option value="gamma" selected="true">gamma</option>
          <option value="proton">proton</option>
        </param>
        <param name="Emax" type="float" value="30" label="Emax (unit: TeV)" />
        <param name="Emin" type="float" value="0.01" label="Emin (unit: TeV)" />
        <param name="EminSource" type="float" value="1.0" label="EminSource (unit: TeV)" />
        <param name="Gamma" type="float" value="2.0" label="Gamma" />
        <param name="EGMF_fG" type="float" value="10" label="EGMF_fG" />
        <param name="lmaxEGMF_Mpc" type="float" value="5" label="lmaxEGMF_Mpc" />
        <param name="jet_half_size" type="float" value="5.0" label="jet_half_size (unit: deg)" />
        <param name="jet_direction" type="float" value="0.0" label="jet_direction (unit: deg)" />
        <param name="psf" type="float" value="1.0" label="psf (unit: deg)" />
        <param name="window_size_RA" type="float" value="2.0" label="window_size_RA (unit: deg)" />
        <param name="window_size_DEC" type="float" value="1.0" label="window_size_DEC (unit: deg)" />
        <param name="EBL" type="select" label="EBL">
          <option value="Franceschini 2017" selected="true">Franceschini 2017</option>
          <option value="Inoue 2012 Baseline">Inoue 2012 Baseline</option>
          <option value="Inoue 2012 lower limit">Inoue 2012 lower limit</option>
          <option value="Inoue 2012 upper limit">Inoue 2012 upper limit</option>
          <option value="Stecker 2016 lower limit">Stecker 2016 lower limit</option>
          <option value="Stecker 2016 upper limit">Stecker 2016 upper limit</option>
        </param>
      </when>
      <when value="model_CTA_events">
        <param name="src_name" type="text" value="Mrk 501" label="src_name" />
        <param name="z_start" type="float" value="0" label="z_start" />
        <param name="Npart" type="integer" value="5000" label="Npart" min="1" max="100000" />
        <param name="particle_type" type="select" label="particle_type">
          <option value="electron">electron</option>
          <option value="gamma" selected="true">gamma</option>
          <option value="proton">proton</option>
        </param>
        <param name="Emax" type="float" value="30" label="Emax (unit: TeV)" />
        <param name="Emin" type="float" value="0.1" label="Emin (unit: TeV)" />
        <param name="EminSource" type="float" value="1.0" label="EminSource (unit: TeV)" />
        <param name="Gamma" type="float" value="2.0" label="Gamma" />
        <param name="EGMF_fG" type="float" value="10" label="EGMF_fG" />
        <param name="lmaxEGMF_Mpc" type="float" value="5" label="lmaxEGMF_Mpc" />
        <param name="jet_half_size" type="float" value="5.0" label="jet_half_size (unit: deg)" />
        <param name="jet_direction" type="float" value="0.0" label="jet_direction (unit: deg)" />
        <param name="window_size_RA" type="float" value="2.0" label="window_size_RA (unit: deg)" />
        <param name="window_size_DEC" type="float" value="1.0" label="window_size_DEC (unit: deg)" />
        <param name="livetime" type="float" value="0.1" label="livetime (unit: day)" />
        <param name="EBL" type="select" label="EBL">
          <option value="Franceschini 2017" selected="true">Franceschini 2017</option>
          <option value="Inoue 2012 Baseline">Inoue 2012 Baseline</option>
          <option value="Inoue 2012 lower limit">Inoue 2012 lower limit</option>
          <option value="Inoue 2012 upper limit">Inoue 2012 upper limit</option>
          <option value="Stecker 2016 lower limit">Stecker 2016 lower limit</option>
          <option value="Stecker 2016 upper limit">Stecker 2016 upper limit</option>
        </param>
      </when>
      <when value="filter_table">
        <param name="fn" type="data" label="fn" format="data" />
        <param name="expression" type="text" value="c1 &gt; 1e3" label="expression" />
        <param name="sep" type="text" value="comma" label="sep" />
      </when>
      <when value="compute_new_column">
        <param name="fn" type="data" label="fn" format="data" />
        <param name="new_column" type="text" value="sum" label="new_column" />
        <param name="expression" type="text" value="c1 + c2" label="expression" />
        <param name="sep" type="text" value="comma" label="sep" />
      </when>
    </conditional>
  </inputs>
  <outputs>
    <data label="${tool.name} -&gt; Generate_events Event_file" name="out_Generate_events_Event_file" format="auto" from_work_dir="Event_file_galaxy.output">
      <filter>_data_product['_selector'] == 'Generate_events'</filter>
    </data>
    <data label="${tool.name} -&gt; histogram_column histogram_data" name="out_histogram_column_histogram_data" format="auto" from_work_dir="histogram_data_galaxy.output">
      <filter>_data_product['_selector'] == 'histogram_column'</filter>
    </data>
    <data label="${tool.name} -&gt; histogram_column histogram_picture" name="out_histogram_column_histogram_picture" format="auto" from_work_dir="histogram_picture_galaxy.output">
      <filter>_data_product['_selector'] == 'histogram_column'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam spectrum_png" name="out_CRbeam_spectrum_png" format="auto" from_work_dir="spectrum_png_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam light_curve_png" name="out_CRbeam_light_curve_png" format="auto" from_work_dir="light_curve_png_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam total_spectrum_table" name="out_CRbeam_total_spectrum_table" format="auto" from_work_dir="total_spectrum_table_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam psf_spectrum_table" name="out_CRbeam_psf_spectrum_table" format="auto" from_work_dir="psf_spectrum_table_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam lc_result" name="out_CRbeam_lc_result" format="auto" from_work_dir="lc_result_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam spectrum" name="out_CRbeam_spectrum" format="auto" from_work_dir="spectrum_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam spectrum_rotated" name="out_CRbeam_spectrum_rotated" format="auto" from_work_dir="spectrum_rotated_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam map3d" name="out_CRbeam_map3d" format="auto" from_work_dir="map3d_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; CRbeam map4d" name="out_CRbeam_map4d" format="auto" from_work_dir="map4d_galaxy.output">
      <filter>_data_product['_selector'] == 'CRbeam'</filter>
    </data>
    <data label="${tool.name} -&gt; model_CTA_events events_summary_png" name="out_model_CTA_events_events_summary_png" format="auto" from_work_dir="events_summary_png_galaxy.output">
      <filter>_data_product['_selector'] == 'model_CTA_events'</filter>
    </data>
    <data label="${tool.name} -&gt; model_CTA_events events_fits_fits" name="out_model_CTA_events_events_fits_fits" format="auto" from_work_dir="events_fits_fits_galaxy.output">
      <filter>_data_product['_selector'] == 'model_CTA_events'</filter>
    </data>
    <data label="${tool.name} -&gt; filter_table outputfile" name="out_filter_table_outputfile" format="auto" from_work_dir="outputfile_galaxy.output">
      <filter>_data_product['_selector'] == 'filter_table'</filter>
    </data>
    <data label="${tool.name} -&gt; compute_new_column outputfile" name="out_compute_new_column_outputfile" format="auto" from_work_dir="outputfile_galaxy.output">
      <filter>_data_product['_selector'] == 'compute_new_column'</filter>
    </data>
  </outputs>
  <tests>
    <test expect_num_outputs="1">
      <conditional name="_data_product">
        <param name="_selector" value="Generate_events" />
        <param name="src_name" value="1ES 1215+303" />
        <param name="z_start" value="0.13" />
        <param name="Npart" value="10000" />
        <param name="particle_type" value="gamma" />
        <param name="Emax" value="50" />
        <param name="Emin" value="0.01" />
        <param name="EminSource" value="0.01" />
        <param name="Gamma" value="2.0" />
        <param name="EGMF_fG" value="100" />
        <param name="lmaxEGMF_Mpc" value="5" />
        <param name="jet_half_size" value="180.0" />
        <param name="jet_direction" value="0.0" />
        <param name="psf" value="180.0" />
        <param name="window_size_RA" value="4.0" />
        <param name="window_size_DEC" value="4.0" />
        <param name="EBL" value="Franceschini 2017" />
      </conditional>
      <assert_stdout>
        <has_text text="*** Job finished successfully ***" />
      </assert_stdout>
    </test>
    <test expect_num_outputs="2">
      <conditional name="_data_product">
        <param name="_selector" value="histogram_column" />
        <param name="fn" location="https://gitlab.renkulab.io/astronomy/mmoda/crbeam/-/raw/45e1cebbe5bb02a20f5f9ec04b3abd48c4f0a613/testfile.tsv" />
        <param name="sep" value="comma" />
        <param name="column" value="c0" />
        <param name="weights" value="c1" />
        <param name="binning" value="logarithmic" />
        <param name="minval" value="10000000000.0" />
        <param name="maxval" value="10000000000000.0" />
        <param name="nbins" value="15" />
        <param name="xlabel" value="Energy, eV" />
        <param name="ylabel" value="Ncounts" />
      </conditional>
      <assert_stdout>
        <has_text text="*** Job finished successfully ***" />
      </assert_stdout>
    </test>
    <test expect_num_outputs="9">
      <conditional name="_data_product">
        <param name="_selector" value="CRbeam" />
        <param name="src_name" value="NGC 1365" />
        <param name="z_start" value="0" />
        <param name="Npart" value="2000" />
        <param name="particle_type" value="gamma" />
        <param name="Emax" value="30" />
        <param name="Emin" value="0.01" />
        <param name="EminSource" value="1.0" />
        <param name="Gamma" value="2.0" />
        <param name="EGMF_fG" value="10" />
        <param name="lmaxEGMF_Mpc" value="5" />
        <param name="jet_half_size" value="5.0" />
        <param name="jet_direction" value="0.0" />
        <param name="psf" value="1.0" />
        <param name="window_size_RA" value="2.0" />
        <param name="window_size_DEC" value="1.0" />
        <param name="EBL" value="Franceschini 2017" />
      </conditional>
      <assert_stdout>
        <has_text text="*** Job finished successfully ***" />
      </assert_stdout>
    </test>
    <test expect_num_outputs="2">
      <conditional name="_data_product">
        <param name="_selector" value="model_CTA_events" />
        <param name="src_name" value="Mrk 501" />
        <param name="z_start" value="0" />
        <param name="Npart" value="5000" />
        <param name="particle_type" value="gamma" />
        <param name="Emax" value="30" />
        <param name="Emin" value="0.1" />
        <param name="EminSource" value="1.0" />
        <param name="Gamma" value="2.0" />
        <param name="EGMF_fG" value="10" />
        <param name="lmaxEGMF_Mpc" value="5" />
        <param name="jet_half_size" value="5.0" />
        <param name="jet_direction" value="0.0" />
        <param name="window_size_RA" value="2.0" />
        <param name="window_size_DEC" value="1.0" />
        <param name="livetime" value="0.1" />
        <param name="EBL" value="Franceschini 2017" />
      </conditional>
      <assert_stdout>
        <has_text text="*** Job finished successfully ***" />
      </assert_stdout>
    </test>
    <test expect_num_outputs="1">
      <conditional name="_data_product">
        <param name="_selector" value="filter_table" />
        <param name="fn" location="https://gitlab.renkulab.io/astronomy/mmoda/crbeam/-/raw/45e1cebbe5bb02a20f5f9ec04b3abd48c4f0a613/testfile.tsv" />
        <param name="expression" value="c1 &gt; 1e3" />
        <param name="sep" value="comma" />
      </conditional>
      <assert_stdout>
        <has_text text="*** Job finished successfully ***" />
      </assert_stdout>
    </test>
    <test expect_num_outputs="1">
      <conditional name="_data_product">
        <param name="_selector" value="compute_new_column" />
        <param name="fn" location="https://gitlab.renkulab.io/astronomy/mmoda/crbeam/-/raw/45e1cebbe5bb02a20f5f9ec04b3abd48c4f0a613/testfile.tsv" />
        <param name="new_column" value="sum" />
        <param name="expression" value="c1 + c2" />
        <param name="sep" value="comma" />
      </conditional>
      <assert_stdout>
        <has_text text="*** Job finished successfully ***" />
      </assert_stdout>
    </test>
  </tests>
</tool>