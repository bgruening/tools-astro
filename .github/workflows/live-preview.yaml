name: Preview PR on galaxy.odahub.fr
on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - labeled
      - synchronize
    paths-ignore:
      - '.github/**'
      - 'deprecated/**'
      - 'docs/**'
      - '*'
env:
  GALAXY_FORK: galaxyproject
  GALAXY_BRANCH: release_23.1

jobs:
  setup:
    if: contains( github.event.pull_request.labels.*.name, 'test-live')
    name: Determine changed repositories
    runs-on: ubuntu-latest
    outputs:
      tool-list: ${{ steps.discover.outputs.tool-list }}
    strategy:
      matrix:
        python-version: ['3.7']
    steps:
    - uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Fake a Planemo run to determine tool list
      uses: galaxyproject/planemo-ci-action@v1
      id: discover
      with:
        galaxy-fork: ${{ env.GALAXY_FORK }}
        galaxy-branch: ${{ env.GALAXY_BRANCH }}
        python-version: ${{ matrix.python-version }}
    - name: Show tool list
      run: echo '${{ steps.discover.outputs.tool-list }}'

  # deploy the tools
  deploy:
    name: Deploy
    if: contains( github.event.pull_request.labels.*.name, 'test-live') and ${{ needs.setup.outputs.tool-list }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.7']

    steps:
    - uses: actions/checkout@v3
    - name: Install requirenments
      run: sudo apt-get install -y ansible
    - name: Save ssh key
      run: echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519 & chmod 600 ~/.ssh/id_rsa
    - name: Populate known_hosts
      run: ssh-keyscan -H galaxy.odahub.fr >> ~/.ssh/known_hosts
    - name: Deploy tools
      env: 
        TOOL_LIST: ${{ needs.setup.outputs.tool-list }}
        pr_num: ${{ github.event.pull_request.number }}
      run: |
        cd deploy-preview

        dir_list=`for tl in $TOOL_LIST ; do echo $tl | awk -F '/' '{print $2}'; done | uniq`

        for dr in $dir_list; do
          tools_list=`for tl in $TOOL_LIST; do if [[ "$tl" == *"$dr"*  ]] ; then basename $tl ; fi ; done`
          
          export tools_list
          export tool_dir=$dr

          ansible-playbook deploy.yml
        done
